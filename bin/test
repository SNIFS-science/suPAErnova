#!/usr/bin/env sh

function run {
    # Trick ROCm into working
    export HSA_OVERRIDE_GFX_VERSION=11.0.0
    # Device Selection
    local device=0
    export HIP_VISIBLE_DEVICES="${device}"

    # Don't immediately fill vram
    export TF_FORCE_GPU_ALLOW_GROWTH="true"

    # TODO: Make Pydantic options
    # local backend="tch"
    local backend="tf"

    local hardware="cpu"
    # local hardware="cuda"
    # local hardware="metal"
    # local hardware="rocm"

    local extra="${backend}-${hardware}"
    
    uv run --group tests --extra "${extra}" pytest $@
}

run $@
